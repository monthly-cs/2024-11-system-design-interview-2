138 ~ 144p 읽음

### 1. 주키퍼의 목적, 제공하는 기능 (139p)
저저번 챕터부터 주키퍼가 꾸준히 등장하고 있는데.. 챕터 2에서 주키퍼가 잠깐 나오긴 했지만 그 때는 일종의 key-value스토어라고만 이해하고 넘어가서 이 놈이 왜 분산시스템에서 필수적인 컴포넌트라는 것인지가 궁금했습니다. 


##### 1) 주키퍼 배경 및 목적
- 분산 시스템에선 각 시스템들이 서로가 어떤 상태인지 등을 모니터링 할 수 있는 환경이 필요
- 시스템마다 상태를 공유할 수 있는 환경을 독자적으로 만들 수도 있겠지만 번거로움
- 그래서 아파치에서 분산 시스템에서 범용적으로 사용할 수 있는 중앙집중식 데이터 저장소인 주키퍼를 만들게 됨
- 주키퍼에서 제공하는 기능을 통해 분산 시스템들이 데이터의 일관성을 유지하고 서버 간의 상태 정보를 비교적 쉽게 관리할 수 있게 됨

##### 2) 주키퍼가 제공하는 기능
1. 시스템들이 공유하는 **공유 상태**의 저장 & 관리
2. 각 시스템 상태 모니터링 
3. 리더 선출 (분산 시스템들이 master - slave 구조일 때 leader가 다운되면 누가 leader가 될지를 선출하는 거. 이거 위해서 주키퍼는 노드 수를 홀수로 맞춘다고 합니다)
4. 분산 락
5. 등등..

<br/>  

### 2. 브로커들의 사본 동기화 (141p)
브로커(서버) 하나가 다운되며 메시지가 소실되는 것을 막기 위해, 토픽을 여러 파티션으로 분리해 여러 브로커에 둘 수 있습니다. 그리고 각 파티션들을 여러 사본으로 복제하여 다시 한 번 만약을 대비합니다. 각 파티션 별로 리더 역할을 하는 애가 있고, 이 리더가 생산자가 발행하는 메시지들을 받는 역할을 하고 사본들이 리더로부터 메시지를 가져가는 식으로 동작합니다. 

이때 ISR(In sync replica)란 개념이 쓰이며, 복제가 되고 있는 사본 그룹을 말합니다. 책에 나온 것처럼 복제가 됐다라고 하는 건 파티션 리더와 사본이 메시지를 완전히 똑같이 갖고 있는게 아닌, 일정 개수 이하만큼만 차이나면 ok임을 의미합니다. 찾아보니.. 리더가 다운될 때는 이 ISR 그룹 내의 노드 중에서 리더가 선출된다고 합니다 (즉 ISR 그룹은 주키퍼 등에서 관리)

새로운 메시지가 발행될 때 앞서 말했듯 리더 파티션에 메시지가 쓰이게 되고, 이 메시지가 모든 ISR에 전파된 후에 ACK를 보내든, 몇 개만 전파됐을 때 보내든, 아니면 리더 파티션에만 쓰이면 보내든.. 이건 그때의 요구사항에 맞춰 설정 가능합니다. 

그리고 144p에서는 Consumer에서 메시지를 가져갈 때 리더 파티션에서 가져가냐, 사본에서 가져가냐에 대한 얘기가 잠깐 언급되는데요. 다른 것보다도 리더 파티션의 데이터가 가장 최근 데이터이므로 단순히 생각해보면 리더에서 가져가는 게 가장 실시간성을 맞추는 방법이라고 생각하지만.. 책에 나오는 것처럼 Consumer와 리더 파티션의 물리적 거리가 멀면 가까운 곳에서 가져가는 것이 나을 것 같네욥

