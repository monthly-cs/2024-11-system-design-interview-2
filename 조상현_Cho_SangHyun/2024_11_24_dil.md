113 ~ 127p 읽음

### 1. 메시지 큐의 단점 및 재밌는 얘기거리 (113p)
113p에서 메시지큐 사용 시의 장점을 말하고 있어, 단점은 어떤 게 있는지 알아봤습니다.


1. 메시지큐 운영에 따른 추가적인 공수 발생이 따르게 됨
2. 노드 간 통신이 메시지큐를 거치게 되므로 네트워크 문제에 따른 지연 등이 추가로 발생 가능
3. 메시지 손실이 발생 가능하며, 이를 방지하려고 디스크에 저장할 순 있으나 디스크 I/O로 인한 추가적인 오베허드가 발생 가능


**"왜 MQ기반 아키텍처가 요즘 인기가 떨어지나요?"** 에 대한 글도 하나 있어 공유합니다.
https://news.hada.io/topic?id=15456


기술적인 단점보다는 "이게 정말 필요하냐?"에 대한 쟁점들이 있는 것 같습니다. 요약하면 (기억에 남는 문장들)

1. MQ는 이미 너무 성숙화된 기술이다
2. 마이크로서비스가 필요한 게 아니면 굳이 MQ 필요 없어도 된다. 오히려 더 복잡해진다
3. MQ가 비즈니스 문제 해결에 정말로 굳이 필요한가? 필요없는데 기술적인 업적을 쌓으려고 괜히 쓰는거 아닌가? (이와 관련해 `Resume Driven Domain(이력서 중심 개발)` 이란 말이 있고, 실제적인 비즈니스 문제 해결보다는 이력서에 쌓을 목적으로 개발하는 패턴을 말하는 것 같은데 이걸 지적하는 것 같네여)

<br/>  

### 2. 메시지 큐, 메시지 브로커, 이벤트 브로커 (114p)
저번 주 스터디(11/21)에서도 간단하게 메시지 큐와 메시지 브로커의 차이에 대해 얘기를 나눈 기억이 있는데 114p에서도 메시지 큐와 이벤트 스트리밍 플랫폼의 차이에 대한 내용이 나옵니다. 관련 용어들의 차이를 간단히 알아봤습니다.

#### 1) 메시지 큐
- 컴포넌트 간의 메시지를 전달하기 위한 컴포넌트
- 메시지를 저장하는 역할

#### 2) 메시지 브로커
- 메시지 큐의 기능을 포함
- 추가적으로 메시지 라우팅(pub/sub 패턴 등을 통해..), 메시지 변환 등도 해줌

#### 3) 이벤트 브로커
- 메시지 브로커의 기능을 포함
- 추가적으로 메시지(이벤트) 보관 등의 기능을 할 수 있음


이 용어들을 실무에서 엄격하게 분리해서 사용하진 않는 것 같습니다. 책 114p에서의 메시지큐 = 메시지 브로커의 의미로 쓰인 것 같습니다.

<br/>  

### 3. 메시지 전달 방식 (115p)
- 최대 한 번 : Consumer에게 딱 한 번만 전송. 메시지 손실 가능성 있으나 각 Consumer들이 메시지를 중복으로 받는 상황은 발생하지 않음

![image](https://github.com/user-attachments/assets/69973aac-cf2c-4c45-a16c-77ce949fde9c)

- 최소 한 번 : Consumer가 메시지를 못 받았다고 판단되면 재전송하여 최소 한 번은 받게 하는 방식. 이로 인해 메시지 손실 가능성은 희박하나 중복으로 받는 상황도 발생 가능

![image](https://github.com/user-attachments/assets/f0e1b363-08cd-4204-98ea-e9cc5b1c7274)

- 정확히 한 번 : 메시지가 Consumer에게 정확히 한 번 보내게 하는 것. 가장 느림. Ack를 못 받으면 다시 전송하긴 함. 그러나 최소 한 번에서는 중복을 방지하려면 Consumer에서 별도 로직을 구현해야 하나(물론 중복되어도 상관없다면 안 해도 됨), 정확히 한 번에서는 Consumer가 브로커와 협력하여 중복을 방지
  
![image](https://github.com/user-attachments/assets/54f8ac53-38e7-4949-bbf3-b0564672aee6)


<br/>  

### 4. 데이터 저장 방식 (123p)
메시지를 읽고 쓰는 것이 빈번하게 발생하며, 큐는 FIFO 구조이므로 메시지들이 순차적으로 저장되므로 읽기/쓰기가 순차적으로 실행됩니다. 대규모로 동시에 발생하는 읽기/쓰기를 둘 다 잘 처리하는 DB는 설계하기 어렵다는 것을 근거로 책에서는 디스크에 로그형식으로 기록하는 방법을 소개하고 있습니다. 이 부분을 읽기 전까지는 단순히 저장이라는 측면에서만 생각해서 DB에 저장해야 하지 않을까라고 생각했는데, 로그로 저장하는 것도 하나의 방안으로 생각해볼 수 있어서 좋았습니다.

관련하여, 데이터를 DB에 저장 vs 파일로 저장하는 방식들을 어느 경우에 쓰면 좋을지 간단히 알아봤습니다.

#### 1) DB
- 데이터 읽기/쓰기 패턴이 디스크 입장에서 랜덤 액세스인 경우 괜찮음. 데이터를 특정 조건으로 검색해야 한다든지..
- 트랜잭션 보장, 데이터 간 관계 설정 등이 필요할 때 사용
- 데이터 저장 시 일관성 보장 등을 고려해야 하는 경우 사용

#### 2) 파일
- 데이터 읽기/쓰기 패턴이 디스크 입장에서 순차 액세스인 경우 괜찮음. 이벤트 스트리밍같은 데이터의 빠른 순차적 처리가 필요한다든지..
- "단순 기록"이 필요한 경우 괜찮음
