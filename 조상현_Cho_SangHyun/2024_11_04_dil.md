23 ~ 27p까지 읽음

### 1. 트리 기반 공간 인덱스 - 구글 S2
구글에서 개발한 지리 정보 시스템 라이브러리로, 쿼드트리처럼 메모리에 구축되는 공간 인덱스입니다. 책 23p에는 힐베르트 곡선을 사용해 1차원으로 공간 데이터를 다룬다는 내용만 나와있는데, 이 문장만으로는 구글 S2가 공간 데이터를 어떻게 표현하는지 감이 잘 안 잡혔습니다. 그래서 구글 S2가 공간 데이터를 어떻게 표현하는지만 살펴봤습니다.

지구에다가 정육면체 형태의 큐브를 투영시킨 뒤, 큐브의 각 면(셀)들을 재귀적으로 4개의 면(셀)들로 세분화합니다. 

![image](https://github.com/user-attachments/assets/cc1eac48-b018-4319-b9c1-9883ff995c30)


위 그림을 평면으로 펼쳐서 도식화하면 다음 형태입니다.

![image](https://github.com/user-attachments/assets/2b9b0e4e-203a-4a0c-98a4-bda1c334e181)


(그림에서는 셀의 가장자리가 휜 형태로 표현되는데, 비행기 경로처럼 구면 위의 직선이라 그런 것이라고 하네요)

이 셀들이 세분화된 횟수를 통해 각 셀들의 레벨이 정해집니다. 최대 30레벨까지 지원하며, 30레벨이어도 각 셀들을 64개의 비트를 통해 식별 가능하다고 합니다. 참고로 30레벨이면 1cm X 1cm 짜리라고 하네용.

<img width="1019" alt="image" src="https://github.com/user-attachments/assets/0557e7d4-7b40-42fd-807c-e435f0579420">


> face-level cell : 처음에 지구에 큐브 투영 시 나오는 6개의 셀

이때 이 셀들에 매겨지는 숫자(위 그림에서 파란색 비트 부분)이 힐베르트 곡선이라는 공간 채움 곡선(평면을 하나의 선으로 꽉 채우는 방법이라고 하네요)으로 방문하는 순서를 토대로 매겨진다고 합니다.

<img width="536" alt="image" src="https://github.com/user-attachments/assets/2340c6cf-212f-4c93-946a-f4146daea31f">


즉 정리하면.. 
쿼드 트리가 2차원 공간을 4개 구역으로 분할하면서 트리 형태로 구조화하는 방식이라면,  
구글 S2는 지구를 3차원 구형으로 나누고, 이를 6개 큰 셀로 시작해 재귀적으로 4분할하며 계층적으로 셀 id를 매기는 방식입니다

<br/>  


### 2. 지오해시 vs 쿼드트리
책에서 앞선 페이지들에서 지오해시와 쿼드트리에 대해 설명해준 것을 바탕으로 종합적으로 정리해봤습니다.

#### 기본 원리
지오해시 : 공간을 2차원 격자들로 분할하고, 각 격자들에 규칙에 따른 특정한 해시값을 부여합니다.  
쿼드트리 : 공간을 재귀적으로 네 개의 사각형 영역으로 분할하여 트리 형태로 구조화합니다.

#### 사용 방법
지오해시 : 해시값을 DB에 컬럼값 등으로 저장해서 활용하는 인덱스입니다.  
쿼드트리 : 지오해시와는 달리 DB에 저장하지 않고 메모리에 구축해서 활용하는 인덱스입니다.

#### 구현의 간단함 정도
지오해시 : 간단합니다. 메모리에 트리 구조 등을 구축해야 할 필요가 없고, 저장할 공간 데이터의 위도와 경도를 지오해시 값으로 인코딩해주면 됩니다.  
쿼드트리 : 복잡합니다. 저장된 공간 데이터들을 토대로 메모리에 트리 구조를 구축해야 하기 때문입니다.

#### 격자 크기 조정
지오해시 : 정밀도(=지오해시값 길이)를 고정하면 격자 크기도 고정되기 때문에, 동적으로 격자 크기를 조정하는 것(공간 데이터가 밀집된 구역에 정밀도가 더 높은 지오해시값을 사용하는 것 등)은 상당히 복잡합니다.  
쿼드트리 : 공간 데이터가 밀집된 구역, 또는 내가 원하는 특정 구역만 세밀하게 격자 크기를 조절할 수 있습니다. (이 경우 해당 구역에 대한 하위 노드들이 많아지는 형태)

#### 인덱스 갱신
지오해시 : 간단합니다. 특정 지오해시 값을 갖는 공간 데이터 하나를 삭제하려면, 그냥(?) 그 레코드만 삭제하면 끝납니다.  
쿼드트리 : 까다롭습니다. 특정 공간 데이터에 대한 정보를 트리에서 삭제하려면 루트노드부터 시작해서 순회하는 과정이 필요하며, 멀티 스레드 환경에선 락을 사용해야 합니다.

#### 용이할 때
지오해시 : 내 위치에서 지정 반경 이내의 공간 데이터 검색을 하는 것이 쉽습니다. 책에서 설명해준 것을 토대로 이유를 생각해보면, 지오해시는 마지막 값을 삭제하여 격자 범위를 확장시켜 검색하는 것이 간단하고, 공통 접두어가 긴 격자들은 서로 인접해있기 때문에 이 점들을 활용해 지정 반경 이내의 공간 데이터 검색을 쉽게 할 수 있습니다.  
쿼드트리 : 내 위치에서 가까운 공간 데이터 k개를 검색하는 것이 쉽습니다. 쿼드 트리를 구축할 때 특정 숫자를 기반으로 하위 노드들이 분할되기 때문에, 이를 활용해 내 위치에서 가까운 k개의 공간 데이터 탐색을 쉽게 할 수 있습니다. 
