52 ~ 57p 읽음

### 1. API 설계
웹소켓 프로토콜에서의 API에서 서버 쪽에선 위치 갱신 API와 웹소켓 초기화 API가 필요하고, 클라이언트는 새로 갱신된 활성 친구들의 위치를 받는 API가 필요합니다. 책에서는 클라이언트 쪽에서 새 친구를 구독하는데 사용되는 API와 구독 해지에 사용할 API도 최소한 만들어야 한다고 얘기하는데.. 얘네는 어디에 쓰는 건지 감이 잘 안 잡히네요,,

<br/>  

### 2. 카산드라 DB
책 54p에는 사용자별로 30초마다의 위치 갱신 이력을 저장하는 DB는 막대한 쓰기 연산 부하를 감당 가능하면서 수평적 확장이 가능해야 함을 소개하고 있고, 그에 대해 카산드라가 적절하다고 말하는데요. 카산드라를 들어보기만 했지 어떤 DB인지는 잘 몰라서 간단하게만 한 번 살펴봤습니다.

기본적으로 분산 NoSQL DB로 다음 특징을 가진다고 합니다.
#### 1) Masterlesss & Peer-to-peer 구조
Master 역할을 하는 노드 없이, 모든 노드가 동일한 역할을 하는 구조입니다. 즉 모든 노드에 데이터 읽기 쓰기가 가능하며, 이는 곧 노드의 추가가 성능의 선형적 증가와 연결된다는 말이고 단일 지점 장애(Single Point Of Failure)가 없다는 말이 됩니다. 노드간에는 P2P를 통해 데이터를 복제한다고 합니다. 

#### 2) 칼럼 패밀리 기반
<img width="903" alt="image" src="https://github.com/user-attachments/assets/14489706-14aa-44a4-8db3-15e04ade302a">

전통적인 테이블 구조가 아니고, 각 행이 서로 다른 칼럼 수와 내용을 가질 수 있어 유연한 데이터 모델링이 가능합니다. 위 구조를를 칼럼 패밀리라고 부른다고 하네요

#### 3) 쓰기 성능
카산드라에서 데이터를 쓸 때는 우선 Commit log에 먼저 데이터 쓰기를 로깅하고, 메모리의 MemTable이란 자료구조에 쓴다고 합니다. 이후 MemTable이 꽉 차면 내용물들을 디스크로 한 번에 flush해서 쓴다고 하는데요, 이 과정을 통해 데이터 쓰기 시 디스크 i/o를 최소한으로 가져갈 뿐더러 한 번 쓸 때 많이 쓰는 방식이라 쓰기 성능이 좋습니다. 예전에 LevelDB라는 디비를 공부한 적이 있는데 거기서도 이런 걸 쓰는 걸 봤어서 개인적으로 신기했습니답

<br/>  

### 3. 웹소켓 서버의 규모 확장성 - draining
웹소켓 서버 클러스터도 사용률 등에 따라 서버를 늘리는 것은 어렵지 않으나, 서버를 삭제하는 경우는 해당 서버로 연결이 맺어진 것들이 있기 때문에 기존 연결들이 종료될 수 있도록 해야 합니다. 해당 노드를 로드밸런서가 `draining(연결 종료 중)`으로 인식시키도록 변경해두면 해당 서버로는 웹소켓 연결이 더 이상 만들어지지 않고, 충분한 시간이 흐른 뒤 해당 서버로의 연결들이 모두 없어지면 그 때 서버를 제거하면 된다고 합니다.

`draining`에 대해 좀 더 알아봤는데요. AWS에서 CLB에서는 `Connection Draining`이라고 부르고, NLB나 ALB에서는 `Deregistration Delay`라고 부른다고 합니다. 처음 보는 개념이라 웹소켓 프로토콜에 한정된 얘기인 줄 알았는데, 굳이 웹소켓이 아니어도 기존에 맺어진 연결은 유지하면서 해당 노드로 더 이상의 요청을 중지하고 싶을 때 사용한다고 합니다. 따로 설정해주는 기능인 줄 알았는데 AWS 로드밸런서는 디폴트로 300초 동안 이 기능을 사용하도록 제공 중이네여 ㄷㄷ

<img width="638" alt="image" src="https://github.com/user-attachments/assets/19808bfa-6ae9-4cb6-94ff-3ae23f4221b7">


<br/>  

### 4. Redis pub/sub - 해시테이블
57p에서 채널 유지를 위해서는 해시 테이블과 링크드 리스트가 필요하다고 해서 뭔가 싶었는데요, Redis pub/sub이 내부적으로 해시 테이블과 링크드 리스트를 사용해 채널과 subscriber들을 관리한다고 합니다. 대략적으로 채널이 key 역할을, 채널의 구독자들(링크드 리스트)가 value 역할을 합니다.

<img width="681" alt="image" src="https://github.com/user-attachments/assets/f75ef962-318f-41ac-b68c-68a113c4b33f">



